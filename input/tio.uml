@startuml
skinparam ranksep 250

package "TDISP PCI Device" {
	[PCIDEV.ConfigurationSpace]
	[PCIDEV.DOE]
}

package "Host.TPA" {
	[Host.TPA.TD]
}

package "Host.Kernel" {
	package	"Host.Kernel.KVM" {
		[Host.KVM.MMUNotifier]
		[Host.KVM.TDExit]
	}
	package "Host.Kernel.VFIO" {
 		[Host.VFIO.ReadWritePCICfg]
		[Host.VFIO.TDISP.Enable]
	[Host.VFIO.TDISP.BindDev]
	[Host.VFIO.TDISP.DeviceRequest]
	}
	package "Host.Kernel.IOMMU"{
		[Host.IOMMU.BindDev]
		[Host.IOMMU.NotifierPageMapUnmap]
	}
	package "Host.Kernel.PCI" {
		package "Host.TDISP" {
			[Host.TDISP.Detect]
			[Host.TDISP.Enable]
			[Host.TDISP.LockDevice]
			[Host.TDISP.DeviceRequest]
			[Host.TDISP.DeviceResponse]
		}
		package "IDE" {
			[Host.IDE.ConfigureIDE]
		}
		package "SPDM" {
			[Host.SPDM.ConfigureSPDM]
		}
		package "DOE" {
			[Host.DOE.ConfigureDOE]
			[Host.DOE.WriteMessage]
			[Host.DOE.ReadMessage]
		}
	}
	package "Host.Kernel.FirmwareDriver"{
		[Host.FirmwareDriver.ConfigureIDE]
		[Host.FirmwareDriver.ConfigureSPDM]
		[Host.FirmwareDriver.BindDev]
		[Host.FirmwareDriver.DeviceRequest]
		[Host.FirmwareDriver.DeviceResponse]
	}
}

package "Host.Userspace.QEMU" {
	[Host.QEMU.VFIOStub]
	[Host.QEMU.TDExitHandler]
	package "SPDM/TDCM/TPA Service" {
		[Host.QEMU.TPAService]
	}
}

package "TDX Module" {
	[Firmware.BindTPA]
	[Firmware.ConfigureIDE]
	[Firmware.ConfigureSPDM]
	[Firmware.CreateDEVIFCS]
	[Firmware.DMARADD]
	[Firmware.DeviceRequest]
	[Firmware.DeviceResponse]
	[Firmware.Guest.DeviceRequest]
	[Firmware.Guest.DeviceResponse]
	[Firmware.Guest.AcceptDevice]
	[Firmware.Guest.EnableTDISP]
}


package "TD" {
	package "Guest.Kernel" {
		package "Guest.Kernel.PCI" {
			[Guest.PCI.DriverProbe]
			[Guest.PCI.EnableTDISP]
			package "Guest.TDISP" {
				[Guest.TDISP.Detect]
				[Guest.TDISP.Enable]
				package "Device Attestation" {
					[Guest.TDISP.GetDeviceReport]
					[Guest.TDISP.AcceptDevice]
					[Guest.TDISP.StartMMIO]
				}
			}
		}
		package "Guest.Firmware.Driver" {
			[Guest.FirmwareDriver.AcceptDevice]
			[Guest.FirmwareDriver.DeviceResponse]
			[Guest.FirmwareDriver.DeviceRequest]
			[Guest.FirmwareDriver.EnableTDISP]
		}
	}
	package "TDI Device Driver" {
		[Guest.TDIDriver.Probe]
	}
}

'TPA TD needs QEMU TPA service
Host.QEMU.TPAService --> Host.TPA.TD

'Binding TPA
Host.TPA.TD --> Firmware.BindTPA

'Ordinary configuration space emulation sequence (Detecting TDISP support in DevCap)
Host.QEMU.VFIOStub <--> Host.VFIO.ReadWritePCICfg
Host.VFIO.ReadWritePCICfg <--> PCIDEV.ConfigurationSpace

'TDExitFlow
Host.KVM.TDExit --> Host.QEMU.TDExitHandler

'Guest requests to enable TDISP via TDVMCALL
Host.QEMU.TDExitHandler --> Host.QEMU.VFIOStub
Host.QEMU.VFIOStub -->Host.VFIO.TDISP.Enable
Host.VFIO.TDISP.Enable --> Host.TDISP.Enable

'Host TDISP enabling flow
'Detect TDISP
Host.TDISP.Enable --> Host.TDISP.Detect
Host.TDISP.Detect --> PCIDEV.ConfigurationSpace

'Configure DOE
Host.TDISP.Enable --> Host.DOE.ConfigureDOE
Host.DOE.ConfigureDOE --> PCIDEV.DOE

'Configure IDE
Host.TDISP.Enable --> Host.IDE.ConfigureIDE
Host.IDE.ConfigureIDE --> Host.FirmwareDriver.ConfigureIDE
Host.FirmwareDriver.ConfigureIDE --> Firmware.ConfigureIDE

'Configure SPDM
Host.TDISP.Enable --> Host.SPDM.ConfigureSPDM
Host.SPDM.ConfigureSPDM --> Host.FirmwareDriver.ConfigureSPDM
Host.FirmwareDriver.ConfigureSPDM --> Firmware.ConfigureSPDM

'TPA assists TDX module on SPDM session setup
Firmware.ConfigureSPDM <--> Host.TPA.TD

'Bind DEVIF to TD
Host.QEMU.VFIOStub --> Host.VFIO.TDISP.BindDev
Host.VFIO.TDISP.BindDev --> Host.IOMMU.BindDev
Host.IOMMU.BindDev --> Host.FirmwareDriver.BindDev
Host.FirmwareDriver.BindDev --> Firmware.CreateDEVIFCS
Host.FirmwareDriver.BindDev --> Firmware.DMARADD

'KVM IOMMU driver notifier
Host.IOMMU.BindDev --> Host.KVM.MMUNotifier
Host.KVM.MMUNotifier --> Host.IOMMU.NotifierPageMapUnmap

'Lock device
Host.VFIO.TDISP.BindDev --> Host.TDISP.LockDevice
Host.TDISP.LockDevice --> Host.TDISP.DeviceRequest

'Host TDISP request
Host.TDISP.DeviceRequest --> Host.FirmwareDriver.DeviceRequest
Host.FirmwareDriver.DeviceRequest --> Firmware.DeviceRequest
Host.TDISP.DeviceRequest --> Host.DOE.WriteMessage
Host.DOE.WriteMessage --> PCIDEV.DOE

'Host TDISP response
Host.TDISP.LockDevice --> Host.TDISP.DeviceResponse
Host.TDISP.DeviceResponse -->Host.DOE.ReadMessage
Host.DOE.ReadMessage <-- PCIDEV.DOE
Host.TDISP.DeviceResponse --> Host.FirmwareDriver.DeviceResponse
Host.FirmwareDriver.DeviceResponse --> Firmware.DeviceResponse

'Opt1: Driver-controlled TDISP enabling
Guest.TDIDriver.Probe --> Guest.PCI.EnableTDISP

'Opt2: TDISP is enabled by default
Guest.PCI.DriverProbe --> Guest.PCI.EnableTDISP

'Guest TDISP enabling
Guest.PCI.EnableTDISP --> Guest.TDISP.Detect
Guest.PCI.EnableTDISP --> Guest.TDISP.Enable

'Enable TDISP via TDVMCALL
Guest.TDISP.Enable --> Guest.FirmwareDriver.EnableTDISP
Guest.FirmwareDriver.EnableTDISP --> Firmware.Guest.EnableTDISP

'AcceptDevice
Guest.TDISP.Enable -->Guest.TDISP.AcceptDevice
Guest.TDISP.AcceptDevice --> Guest.FirmwareDriver.AcceptDevice
Guest.FirmwareDriver.AcceptDevice --> Firmware.Guest.AcceptDevice

'TDExitHandling
Host.QEMU.VFIOStub --> Host.VFIO.TDISP.DeviceRequest
Host.VFIO.TDISP.DeviceRequest --> Host.TDISP.DeviceRequest
Host.VFIO.TDISP.DeviceRequest --> Host.TDISP.DeviceResponse

'DeviceRequest(GetDeviceReport)
Guest.TDISP.Enable --> Guest.TDISP.GetDeviceReport 
Guest.TDISP.GetDeviceReport --> Guest.FirmwareDriver.DeviceRequest
Guest.FirmwareDriver.DeviceRequest -->Firmware.Guest.DeviceRequest
Guest.TDISP.GetDeviceReport --> Guest.FirmwareDriver.DeviceResponse
Guest.FirmwareDriver.DeviceResponse --> Firmware.Guest.DeviceResponse

'StartMMIO
Guest.TDISP.Enable --> Guest.TDISP.StartMMIO
Guest.TDISP.StartMMIO --> Guest.FirmwareDriver.DeviceRequest
Guest.TDISP.StartMMIO --> Guest.FirmwareDriver.DeviceResponse
@enduml
